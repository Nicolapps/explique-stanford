#!/usr/bin/env node
/**
 * Stand-alone fake Tequila server
 */

var FakeTequilaServer = require("../fakes").TequilaServer,
    server = new FakeTequilaServer(argv2opts(process.argv));

server.port = process.env.FAKE_TEQUILA_PORT || 3011;
server.start(function (err) {
    if (err) {
        console.log(err);
    } else {
        console.log("Fake Tequila server listening on port " + server.port);
    }
});

function argv2opts (argv) {
    const opts = {};

    for(let i = 1; i < argv.length; i++) {
        const arg = argv[i];
        if (arg.endsWith("fake_tequila_server")) continue;

        if (arg.startsWith("--config-file")) {
            opts.configFile = takeStringValue(argv, i);
        } else {
            console.error(`Unknown option: ${arg}`);
            process.exit(1);
        }
    }

    return opts;
}

/**
 * Get and consume a string argument in argv at position i.
 *
 * If argv[i] has an equal sign, pick the part after it and leave argv
 * unchanged. Otherwise, splice and return argv[i + 1] (that is,
 * mutate argv so that argv[i + 1] is removed).
 */
function takeStringValue(argv, i) {
    const sliceAt = argv[i].indexOf("=")
    return sliceAt > -1 ? argv[i].slice(sliceAt + 1) : argv.splice(i + 1, 1)[0]
}
